local login = {}
local utils = require "utils"
local errorcode = require "login.loginerrorcode"
local config = require("login.loginconfig")
local loginUtils = require("login.loginutils")
local crypt = require "skynet.crypt"

local handshaketimeout
local logintimeout
local playerinfo
local logininfo
local agent

function login.join(a)
    agent = a
end

function login.quit()
    playerinfo = nil
    logininfo = nil
    if handshaketimeout then
        handshaketimeout()
        handshaketimeout = nil
    end
    if logintimeout then
        logintimeout()
        logintimeout = nil
    end
end

login.REQUEST = {}

function login.REQUEST:handshake()
    if handshaketimeout then
        handshaketimeout()
        handshaketimeout = nil
    end

    if not logintimeout then
        local code = loginUtils.ContrastVersion(self.largeversion, self.smallversion,
                config.largeversion, config.smallversion)
        if code ~= errorcode["成功"] then
            ---握手失败1秒后踢出
            if logintimeout then
                logintimeout()
                logintimeout = nil
            end
            utils.timeout(100, function ()
                if agent then
                    agent:close()
                end
            end)
        else
            ---握手成功后10秒没有登录就踢出
            logintimeout = utils.cancelable_timeout(1000, function ()
                if agent then
                    agent:close()
                end
            end)
        end
        return { code = code,
                 largeversion = config.largeversion,
                 smallversion = config.smallversion }
    else
        logintimeout()
        logintimeout = nil
        utils.timeout(100, function ()
            if agent then
                agent:close()
            end
        end)
        return { code = errorcode["登录流程颠倒"],
                 largeversion = config.largeversion,
                 smallversion = config.smallversion }
    end
end

function login.REQUEST:login()
    if handshaketimeout then
        ---没有握手，1秒后踢出
        handshaketimeout()
        handshaketimeout = nil
        utils.timeout(100, function ()
            if agent then
                agent:close()
            end
        end)
        return { code = errorcode["登录流程颠倒"] }
    end

    playerinfo = nil
    logininfo = nil

    local account = crypt.base64decode(self.account)
    local password = crypt.base64decode(self.password)
    local platform = crypt.base64decode(self.platform)
    local channel = crypt.base64decode(self.channel)
    local clientid = crypt.base64decode(self.clientid)
    local external = crypt.base64decode(self.external)

    local res = agent:getAccountInfo(account)
    if  res and #res > 0 then
        if password and
                loginUtils.GetPassword(password) == res[1].password then
            if logintimeout then
                logintimeout()
                logintimeout = nil
            end
            playerinfo = res[1]
            logininfo = {
                account = account,
                platform = platform,
                channel = channel,
                clientid = clientid,
                external = external
            }
            return {
                code = 0,
                token = loginUtils.GetToken(account,
                        password, agent.addr, clientid),
                gameip = "101.132.77.100",
                gameport = 20013,
            }
        else
            return { code = errorcode["密码错误"] }
        end
    else
        return { code = errorcode["无此帐号"] }
    end
end

function login.REQUEST:heartbeat()
    print("RESPONSE:hello:", self and self.what or nil)
    return {result = string.format("I get:%s",
            self and self.what or "nil")}
end

function login.REQUEST:hello()
    print("REQUEST:hello:", self and self.msg or nil)
    return {msg = "server vesion:0.0.1"}
end

login.RESPONSE = {}

return login